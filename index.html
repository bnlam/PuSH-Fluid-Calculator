<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BMI & Fluid Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState } = React;
    const round0 = (n) => Math.round(n);
    const round1 = (n) => Math.round(n * 10) / 10;

    function App() {
      const [weightKg, setWeightKg] = useState(70);
      const [heightCm, setHeightCm] = useState(170);
      const [arm, setArm] = useState("intervention");

      const heightM = useMemo(() => (heightCm ? heightCm / 100 : 0), [heightCm]);
      const bmi = useMemo(() => (heightM > 0 ? weightKg / (heightM * heightM) : 0), [weightKg, heightM]);

      const dosingWeightKg = useMemo(() => {
        if (!heightM || heightM <= 0) return 0;
        const adjusted = 40 * heightM * heightM;
        return bmi > 40 ? adjusted : weightKg;
      }, [bmi, heightM, weightKg]);

      const bmiFlagText = bmi > 40 ? "BMI ≥ 40: dosing capped to BMI 40 (adjusted weight)" : "BMI < 40: actual weight used";

      const controlRateMlHr = useMemo(() => {
        if (dosingWeightKg <= 0) return 0;
        return Math.min(1.5 * dosingWeightKg, 500 / 3);
      }, [dosingWeightKg]);
      const controlTotalMl3h = useMemo(() => Math.min(controlRateMlHr * 3, 500), [controlRateMlHr]);

      const bolusVolMl = useMemo(() => (dosingWeightKg > 0 ? 20 * dosingWeightKg : 0), [dosingWeightKg]);
      const theoreticalContRate = useMemo(() => (dosingWeightKg > 0 ? 3 * dosingWeightKg : 0), [dosingWeightKg]);
      const contRateMlHr = useMemo(() => {
        if (theoreticalContRate <= 0) return 0;
        return theoreticalContRate * 3 <= 1000 ? theoreticalContRate : 1000 / 3;
      }, [theoreticalContRate]);
      const contTotal3hMl = useMemo(() => contRateMlHr * 3, [contRateMlHr]);
      const totalInterventionMl = useMemo(() => bolusVolMl + contTotal3hMl, [bolusVolMl, contTotal3hMl]);

      const reset = () => {
        setWeightKg(70);
        setHeightCm(170);
        setArm("intervention");
      };

      return (
        <div className="min-h-screen p-6">
          <div className="max-w-3xl mx-auto">
            <header className="mb-6">
              <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">BMI & Fluid Calculator</h1>
            </header>

            <div className="grid md:grid-cols-2 gap-4">
              <div className="bg-white rounded-2xl shadow p-4">
                <h2 className="font-medium mb-3">Patient</h2>
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm text-slate-600">Weight (kg)</label>
                    <input type="number" min={1} step={0.1} value={weightKg} onChange={(e) => setWeightKg(Number(e.target.value))} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-600">Height (cm)</label>
                    <input type="number" min={30} step={0.1} value={heightCm} onChange={(e) => setHeightCm(Number(e.target.value))} className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2" />
                  </div>
                  <div className="grid grid-cols-3 gap-3 text-sm">
                    <div className="bg-slate-50 rounded-xl p-3 border">
                      <div className="text-slate-600">BMI</div>
                      <div className="text-lg font-semibold">{heightM ? (weightKg / (heightM * heightM)).toFixed(1) : "—"}</div>
                    </div>
                    <div className="bg-slate-50 rounded-xl p-3 border">
                      <div className="text-slate-600">Actual weight</div>
                      <div className="text-lg font-semibold">{round1(weightKg)} kg</div>
                    </div>
                    <div className="bg-slate-50 rounded-xl p-3 border">
                      <div className="text-slate-600">Dosing weight</div>
                      <div className="text-lg font-semibold">{round1(dosingWeightKg)} kg</div>
                    </div>
                  </div>
                  <div className={`px-3 py-2 rounded-xl text-xs ${bmi > 40 ? "bg-amber-100 text-amber-900" : "bg-green-100 text-green-800"}`}>{bmiFlagText}</div>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow p-4">
                <h2 className="font-medium mb-3">Regimen</h2>
                <fieldset className="space-y-2">
                  <label className="flex items-center gap-2">
                    <input type="radio" name="arm" value="intervention" checked={arm === "intervention"} onChange={() => setArm("intervention")} />
                    <span className="text-sm">Intervention</span>
                  </label>
                  <label className="flex items-center gap-2">
                    <input type="radio" name="arm" value="control" checked={arm === "control"} onChange={() => setArm("control")} />
                    <span className="text-sm">Control</span>
                  </label>
                </fieldset>

                {arm === "control" && (
                  <div className="mt-4 space-y-3">
                    <div className="grid grid-cols-3 gap-3 text-sm">
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Max rate (mL/hr)</div>
                        <div className="text-lg font-semibold">{round0(controlRateMlHr)}</div>
                      </div>
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Duration</div>
                        <div className="text-lg font-semibold">3 hr</div>
                      </div>
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Max total (3 hr)</div>
                        <div className="text-lg font-semibold">{round0(controlTotalMl3h)} mL</div>
                      </div>
                    </div>
                  </div>
                )}

                {arm === "intervention" && (
                  <div className="mt-4 space-y-3">
                    <div className="grid grid-cols-2 gap-3 text-sm">
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Bolus volume (1 hr)</div>
                        <div className="text-lg font-semibold">{round0(bolusVolMl)} mL</div>
                      </div>
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Continuous rate</div>
                        <div className="text-lg font-semibold">{round0(contRateMlHr)} mL/hr</div>
                      </div>
                    </div>
                    <div className="grid grid-cols-3 gap-3 text-sm">
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Continuous duration</div>
                        <div className="text-lg font-semibold">3 hr</div>
                      </div>
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Continuous total (3 hr)</div>
                        <div className="text-lg font-semibold">{round0(contTotal3hMl)} mL</div>
                      </div>
                      <div className="bg-slate-50 rounded-xl p-3 border">
                        <div className="text-slate-600">Grand total</div>
                        <div className="text-lg font-semibold">{round0(totalInterventionMl)} mL</div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            <div className="mt-6 bg-white rounded-2xl shadow p-4 border border-amber-200">
              <h3 className="font-medium mb-2 flex items-center gap-2"><span className="px-2 py-0.5 rounded bg-amber-100 text-amber-900 text-xs">Dosing policy</span> BMI ≥ 40 cap</h3>
              <p className="text-sm text-slate-700">
                BMI is not an exclusion criterion for the study. However, at BMI &gt; 40 kg/m², matching fluid infusion rates to overall body weight may result in excessive hydration. In line with other trial protocols, we cap infusion rates for patients with BMI &gt; 40 by assuming BMI = 40 for dosing calculations.
              </p>
            </div>

            <div className="mt-6 flex flex-wrap gap-3 no-print">
              <button onClick={() => window.print()} className="px-4 py-2 rounded-2xl bg-indigo-600 text-white shadow hover:bg-indigo-700">Print / Save PDF</button>
              <button onClick={reset} className="px-4 py-2 rounded-2xl bg-slate-200 text-slate-800 hover:bg-slate-300">Reset</button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
